<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <title>ë§›ì§‘ ì •ë³´ ê²€ìƒ‰</title>
    <th:block layout:fragment="css">
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" th:href="@{/css/lunchmatch/lunchmatch.css}">
    </th:block>
</head>

<div layout:fragment="content">
    <div class="bg-gray-100">
        <div class="container mx-auto p-4 flex flex-col" style="height: calc(100vh - 130px);">
            <div class="text-center mt-4 mb-2">
                <div class="board-title-box">ë§›ì§‘ ì •ë³´ ê²€ìƒ‰ ğŸ”</div>
            </div>
            <p class="text-center text-gray-500 mb-4">ì›í•˜ëŠ” ì¥ì†Œë¥¼ ê²€ìƒ‰í•˜ì—¬ ë§›ì§‘ì„ ì°¾ì•„ë³´ì„¸ìš”.</p>
            <hr class="my-4 shadow-hr">

            <div class="flex-grow grid grid-cols-1 md:grid-cols-3 gap-4 min-h-0">
                <div id="menu_wrap" class="bg-white p-4 rounded-lg shadow-md col-span-1 flex flex-col h-full overflow-hidden">
                    <div class="flex-shrink-0">
                        <form id="searchForm" onsubmit="performSearch(event, 1)" class="flex gap-2">
                            <input type="text" id="keyword" value="ë¶€ì‚° ì„œë©´" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ì¥ì†Œ í‚¤ì›Œë“œ (ì˜ˆ: ë¶€ì‚° ì„œë©´)"/>
                            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">ê²€ìƒ‰</button>
                        </form>
                    </div>
                    <div class="filters my-4 flex flex-wrap gap-2 items-center flex-shrink-0">
                        <div class="flex-grow">
                            <label for="category" class="block text-sm font-medium text-gray-700">ìŒì‹ ì¢…ë¥˜:</label>
                            <select id="category" onchange="performSearch(null, 1)" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="ë§›ì§‘">ì „ì²´ ë§›ì§‘</option>
                                <option value="í•œì‹">í•œì‹</option>
                                <option value="ì¤‘ì‹">ì¤‘ì‹</option>
                                <option value="ì¼ì‹">ì¼ì‹</option>
                                <option value="ì–‘ì‹">ì–‘ì‹</option>
                                <option value="ì¹´í˜">ì¹´í˜</option>
                                <option value="ë¶„ì‹">ë¶„ì‹</option>
                            </select>
                        </div>
                        <div class="flex-grow">
                            <label for="sort" class="block text-sm font-medium text-gray-700">ì •ë ¬ ê¸°ì¤€:</label>
                            <select id="sort" onchange="applySortOnly()" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="accuracy">ê¸°ë³¸ìˆœ</option>
                                <option value="name">ì´ë¦„ìˆœ</option>
                                <option value="distance">ê±°ë¦¬ìˆœ</option>
                            </select>
                        </div>
                    </div>
                    <hr class="mb-4 flex-shrink-0"/>
                    <ul id="placesList" class="space-y-2 flex-grow overflow-y-auto"></ul>
                    <div id="pagination" class="mt-4 flex justify-between items-center flex-shrink-0">
                        <button id="prevBtn" onclick="movePage(-1)" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed">ì´ì „</button>
                        <span id="pageInfo" class="text-gray-700 text-sm"></span>
                        <button id="nextBtn" onclick="movePage(1)" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed">ë‹¤ìŒ</button>
                    </div>
                </div>
                <div class="relative col-span-1 md:col-span-2 rounded-lg shadow-md overflow-hidden">
                    <div id="map"></div>
                    <button onclick="openFullScreenMap()" class="absolute top-2 right-2 bg-white text-gray-700 font-semibold py-2 px-4 rounded-full shadow-lg z-10 hover:bg-gray-200 transition">
                        ì „ì²´ ì§€ë„ ë³´ê¸°
                    </button>
                    <button onclick="displayMyLocation()" class="absolute top-14 right-2 bg-white p-2 rounded-full shadow-lg z-10 hover:bg-gray-200 text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                    </button>
                    <div class="absolute top-2 left-2 z-10">
                        <select id="radiusSelect" onchange="changeSearchRadius()" class="bg-white text-gray-700 text-sm py-2 px-3 rounded-md shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="500">500m</option>
                            <option value="1000">1km</option>
                            <option value="2000">2km</option>
                            <option value="5000">5km</option>
                            <option value="10000">10km</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div id="fullscreen-map-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center opacity-0 pointer-events-none">
            <div class="relative w-11/12 h-5/6 bg-white rounded-lg shadow-2xl p-4">
                <div id="fullscreen-map" class="w-full h-full rounded-lg"></div>
                <button onclick="closeFullScreenMap()" class="absolute top-4 right-4 bg-white text-gray-800 font-bold py-2 px-4 rounded-full shadow-xl hover:bg-gray-200 transition z-10">
                    ë‹«ê¸°
                </button>
                <button onclick="displayMyLocationOnModal()" class="absolute top-20 right-4 bg-white p-2 rounded-full shadow-lg z-10 hover:bg-gray-200 text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                </button>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        const KAKAO_JAVASCRIPT_API_KEY = /*[[${kakaoJsApiKey}]]*/ 'YOUR_DEFAULT_KEY';
    </script>
    <script th:src="|//dapi.kakao.com/v2/maps/sdk.js?appkey=${kakaoJsApiKey}&libraries=services|"></script>
    <script>
        let map;
        let markers = [];
        let infowindow = new kakao.maps.InfoWindow({zIndex:1});
        let originalPlaces = [];
        let userLocation = null;
        let myLocationMarker = null;
        let myLocationCircle = null;
        let currentSearchRadius = 500;
        let currentActiveMarker = null;
        let currentPage = 1;
        let totalPage = 1;
        let modalMap;
        let modalMyLocationMarker = null;
        let modalMyLocationCircle = null;


        document.addEventListener("DOMContentLoaded", function() {
            const mapContainer = document.getElementById('map');
            const mapOption = { center: new kakao.maps.LatLng(35.1576, 129.0594), level: 4 };
            map = new kakao.maps.Map(mapContainer, mapOption);
            performSearch(null, 1);
        });

        async function performSearch(event, page) {
            if (event) event.preventDefault();
            currentPage = page;
            const keyword = document.getElementById('keyword').value.trim();
            const category = document.getElementById('category').value;
            if (!keyword) { alert('ì¥ì†Œ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
            const fullKeyword = `${keyword} ${category}`;
            try {
                const response = await fetch(`/lunchmatch/searchKakaoPlaces?query=${encodeURIComponent(fullKeyword)}&page=${currentPage}`);
                if (!response.ok) throw new Error(`ì„œë²„ API í˜¸ì¶œ ì‹¤íŒ¨`);
                const data = await response.json();
                originalPlaces = data.documents;
                renderPagination(data.meta);
                applySortOnly();
                if (originalPlaces.length > 0) {
                    const bounds = new kakao.maps.LatLngBounds();
                    originalPlaces.forEach(place => {
                        if (typeof place.y === 'string' && typeof place.x === 'string' && !isNaN(parseFloat(place.y)) && !isNaN(parseFloat(place.x))) {
                            bounds.extend(new kakao.maps.LatLng(parseFloat(place.y), parseFloat(place.x)));
                        }
                    });
                    if (!bounds.isEmpty()) map.setBounds(bounds);
                    else map.setCenter(new kakao.maps.LatLng(35.1576, 129.0594));
                } else {
                    map.setCenter(new kakao.maps.LatLng(35.1576, 129.0594));
                }
            } catch (error) {
                console.error('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                alert('ì¥ì†Œ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                originalPlaces = [];
                displayPlaces([]);
                renderPagination({ pageable_count: 0, is_end: true });
            }
        }

        function movePage(delta) {
            const newPage = currentPage + delta;
            if (newPage > 0 && newPage <= totalPage) {
                performSearch(null, newPage);
            }
        }

        function renderPagination(meta) {
            const pageableCount = meta.pageable_count > 45 ? 45 : meta.pageable_count;
            totalPage = Math.ceil(pageableCount / 15);
            document.getElementById('pageInfo').textContent = `${currentPage} / ${totalPage}`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPage || meta.is_end;
        }

        function applySortOnly() {
            const sort = document.getElementById('sort').value;
            let processedPlaces = [...originalPlaces];
            if (sort === 'distance') {
                getUserLocation((errorOccurred) => {
                    if (errorOccurred) {
                        document.getElementById('sort').value = 'accuracy';
                        alert("ê±°ë¦¬ìˆœ ì •ë ¬ì„ ìœ„í•´ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ìˆœìœ¼ë¡œ ì •ë ¬í•©ë‹ˆë‹¤.");
                        applySortOnly();
                        return;
                    }
                    updatePlacesDistances(processedPlaces);
                    processedPlaces.sort((a, b) => (a.distance ?? Infinity) - (b.distance ?? Infinity));
                    displayPlaces(processedPlaces);
                });
            } else {
                if (sort === 'name') {
                    processedPlaces.sort((a, b) => a.place_name.localeCompare(b.place_name));
                }
                updatePlacesDistances(processedPlaces, () => displayPlaces(processedPlaces));
            }
        }

        function getUserLocation(callback, forceRefresh = false) {
            // ê°•ì œ ìƒˆë¡œê³ ì¹¨ì´ ì•„ë‹ˆê³ , ê¸°ì¡´ ìœ„ì¹˜ ì •ë³´ê°€ ìˆì„ ë•Œë§Œ ìºì‹œë¥¼ ì‚¬ìš©
            if (userLocation && !forceRefresh) {
                return callback();
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {

                    // ================================================================
                    // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ ë””ë²„ê¹… ì½”ë“œ ì¶”ê°€ â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
                    console.log("ë¸Œë¼ìš°ì €ê°€ ì „ë‹¬í•œ ìœ„ì¹˜ ì •ë³´:", position);
                    alert(`ìƒˆë¡œ ë°›ì€ ì¢Œí‘œ:\nìœ„ë„: ${position.coords.latitude}\nê²½ë„: ${position.coords.longitude}`);
                    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–² ë””ë²„ê¹… ì½”ë“œ ì¶”ê°€ â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
                    // ================================================================

                    userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                    if (callback) callback();
                }, error => {
                    if (callback) callback(true);
                }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
            } else {
                if (callback) callback(true);
            }
        }

        function displayMyLocation() {
            // 'ë‚´ ìœ„ì¹˜ ë³´ê¸°' ê¸°ëŠ¥ì€ ë‹¤ë¥¸ ê¸°ëŠ¥ê³¼ ë…ë¦½ì ìœ¼ë¡œ, í•­ìƒ ìƒˆë¡œ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            if (navigator.geolocation) {
                // ì˜µì…˜ì„ í†µí•´ ë¸Œë¼ìš°ì € ìºì‹œë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šë„ë¡ ëª…ì‹œí•©ë‹ˆë‹¤.
                const geoOptions = {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                };

                navigator.geolocation.getCurrentPosition(position => {
                    // 1. ìƒˆë¡œ ê°€ì ¸ì˜¨ ì •í™•í•œ ìœ„ì¹˜ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì¦‰ì‹œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
                    //    ì´ë ‡ê²Œ í•´ì•¼ ëª©ë¡ì˜ ê±°ë¦¬ í‘œì‹œë„ ì´ ìµœì‹  ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë‹¤ì‹œ ê³„ì‚°ë©ë‹ˆë‹¤.
                    userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };

                    // 2. ì§€ë„ì— 'ë‚´ ìœ„ì¹˜' ë§ˆì»¤ì™€ ì›ì„ ìƒˆë¡œ ê·¸ë¦½ë‹ˆë‹¤.
                    const locPosition = new kakao.maps.LatLng(userLocation.lat, userLocation.lng);
                    if (myLocationMarker) myLocationMarker.setMap(null);
                    if (myLocationCircle) myLocationCircle.setMap(null);

                    myLocationMarker = new kakao.maps.Marker({
                        map: map,
                        position: locPosition,
                        image: new kakao.maps.MarkerImage('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png', new kakao.maps.Size(24, 35), {offset: new kakao.maps.Point(12, 35)})
                    });
                    myLocationCircle = new kakao.maps.Circle({
                        map: map,
                        center: locPosition,
                        radius: currentSearchRadius,
                        strokeWeight: 2,
                        strokeColor: '#004CFF',
                        strokeOpacity: 0.8,
                        strokeStyle: 'dashed',
                        fillColor: '#CCE7FF',
                        fillOpacity: 0.5
                    });
                    map.setCenter(locPosition);
                    map.setLevel(calculateLevelForRadius(currentSearchRadius));

                    // 3. í˜„ì¬ í‘œì‹œëœ ì¥ì†Œ ëª©ë¡ì˜ ê±°ë¦¬ë¥¼ ìƒˆë¡œê³ ì¹¨ëœ ìœ„ì¹˜ ê¸°ì¤€ìœ¼ë¡œ ë‹¤ì‹œ ê³„ì‚°í•˜ê³ ,
                    //    í™”ë©´ì„ ì—…ë°ì´íŠ¸í•˜ì—¬ ì¦‰ì‹œ ë°˜ì˜í•©ë‹ˆë‹¤.
                    updatePlacesDistances(originalPlaces, () => {
                        // ë§Œì•½ í˜„ì¬ 'ê±°ë¦¬ìˆœ'ìœ¼ë¡œ ì •ë ¬ëœ ìƒíƒœì˜€ë‹¤ë©´, ëª©ë¡ ìˆœì„œë„ ë‹¤ì‹œ ì •ë ¬í•©ë‹ˆë‹¤.
                        if (document.getElementById('sort').value === 'distance') {
                            originalPlaces.sort((a, b) => (a.distance ?? Infinity) - (b.distance ?? Infinity));
                        }
                        displayPlaces(originalPlaces);
                    });

                }, () => {
                    alert('ì˜¤ë¥˜: ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }, geoOptions);
            } else {
                alert('ì˜¤ë¥˜: ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        function changeSearchRadius() {
            currentSearchRadius = parseInt(document.getElementById('radiusSelect').value);
            if (myLocationCircle) myLocationCircle.setRadius(currentSearchRadius);
        }

        function calculateLevelForRadius(radius) {
            if (radius <= 500) return 4; if (radius <= 1000) return 5;
            if (radius <= 2000) return 6; if (radius <= 5000) return 7;
            return 8;
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2-lat1) * Math.PI/180; const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function updatePlacesDistances(places, callback) {
            if (!userLocation || !places) {
                if (callback) callback();
                return;
            }
            places.forEach(place => {
                const lat = parseFloat(place.y); const lng = parseFloat(place.x);
                if (!isNaN(lat) && !isNaN(lng)) {
                    place.distance = getDistance(userLocation.lat, userLocation.lng, lat, lng);
                } else { place.distance = null; }
            });
            if (callback) callback();
        }

        function displayPlaces(places) {
            const listEl = document.getElementById('placesList');
            removeAllChildNods(listEl);
            removeMarker();
            if (!places || places.length === 0) {
                listEl.innerHTML = '<li class="text-gray-500">ì„ íƒí•œ ì¡°ê±´ì— ë§ëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
                return;
            }
            places.forEach((place, i) => {
                if (typeof place.y === 'string' && typeof place.x === 'string' && !isNaN(parseFloat(place.y)) && !isNaN(parseFloat(place.x))) {
                    const placePosition = new kakao.maps.LatLng(parseFloat(place.y), parseFloat(place.x));
                    const marker = addMarker(placePosition, i, place.id, place.place_name);
                    const itemEl = getListItem(i, place);
                    listEl.appendChild(itemEl);
                    itemEl.onmouseover = () => {
                        const targetMarker = markers.find(m => m.placeId === place.id);
                        if (targetMarker && currentActiveMarker !== targetMarker) {
                            targetMarker.setImage(targetMarker.hoverImage);
                            infowindow.setContent(`<div class="info"><div class="title">${place.place_name}</div></div>`);
                            infowindow.open(map, targetMarker);
                        }
                    };
                    itemEl.onmouseout = () => {
                        const targetMarker = markers.find(m => m.placeId === place.id);
                        if (targetMarker && currentActiveMarker !== targetMarker) {
                            targetMarker.setImage(targetMarker.normalImage);
                            infowindow.close();
                        }
                    };
                    itemEl.onclick = (event) => {
                        if (event.target.tagName === 'BUTTON' || event.target.closest('a')) return;
                        const targetMarker = markers.find(m => m.placeId === place.id);
                        if (targetMarker) {
                            if (currentActiveMarker && currentActiveMarker !== targetMarker) currentActiveMarker.setImage(currentActiveMarker.normalImage);
                            targetMarker.setImage(targetMarker.hoverImage);
                            currentActiveMarker = targetMarker;
                            map.panTo(targetMarker.getPosition());
                            infowindow.setContent(`<div class="info"><div class="title">${place.place_name}</div></div>`);
                            infowindow.open(map, targetMarker);
                            highlightListItem(place.id);
                        }
                    };
                }
            });
        }

        function addMarker(position, idx, placeId, placeName) {
            const normalImageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_number_blue.png', imageSize = new kakao.maps.Size(36, 37);
            const normalImgOptions = { spriteSize: new kakao.maps.Size(36, 691), spriteOrigin: new kakao.maps.Point(0, (idx * 46) + 10), offset: new kakao.maps.Point(13, 37) };
            const markerImageNormal = new kakao.maps.MarkerImage(normalImageSrc, imageSize, normalImgOptions);
            const hoverImageSrc = 'http://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png', hoverImageSize = new kakao.maps.Size(31, 35);
            const hoverImgOptions = { offset: new kakao.maps.Point(13, 34) };
            const markerImageHover = new kakao.maps.MarkerImage(hoverImageSrc, hoverImageSize, hoverImgOptions);
            const marker = new kakao.maps.Marker({ position: position, image: markerImageNormal });
            marker.normalImage = markerImageNormal; marker.hoverImage = markerImageHover;
            marker.placeId = placeId; marker.placeName = placeName;
            marker.setMap(map); markers.push(marker); return marker;
        }

        function removeMarker() {
            markers.forEach(m => m.setMap(null)); markers = [];
            currentActiveMarker = null; infowindow.close();
        }

        function highlightListItem(placeId) {
            document.querySelectorAll('#placesList .highlighted').forEach(el => el.classList.remove('highlighted'));
            const itemEl = document.querySelector(`#placesList div[data-place-id="${placeId}"]`);
            if (itemEl) {
                itemEl.classList.add('highlighted');
                itemEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function getListItem(index, place) {
            const el = document.createElement('li');
            const distanceInfo = place.distance ? `<span class="text-sm font-semibold ${place.distance * 1000 <= currentSearchRadius ? 'text-red-500' : 'text-blue-500'}">ê±°ë¦¬: ${place.distance.toFixed(2)}km</span>` : '';
            el.innerHTML = `<div class="p-3 border rounded-lg hover:bg-gray-100 cursor-pointer" data-place-id="${place.id}">
                                <div class="flex justify-between items-start">
                                    <div><h5 class="font-bold text-blue-600">${index + 1}. ${place.place_name}</h5></div>
                                    <div class="flex flex-col items-end gap-2">${distanceInfo}<button onclick="savePlace(event, ${index})" class="bg-green-500 text-white text-xs px-2 py-1 rounded hover:bg-green-600">ì €ì¥</button></div>
                                </div>
                                ${place.road_address_name ? `<span class="text-sm text-gray-700">${place.road_address_name}</span><span class="text-xs text-gray-500 block">${place.address_name}</span>` : `<span class="text-sm text-gray-700">${place.address_name}</span>`}
                                <span class="text-sm text-green-600">${place.phone}</span>
                            </div>`;
            return el;
        }

        async function savePlace(event, index) {
            event.stopPropagation();
            const place = originalPlaces[index];
            const placeData = {
                name: place.place_name, address: place.road_address_name || place.address_name,
                phoneNumber: place.phone, category: place.category_name,
                latitude: parseFloat(place.y), longitude: parseFloat(place.x),
                rating: null, priceLevel: null, operatingHours: null
            };
            if (placeData.category && placeData.category.includes('>')) {
                placeData.category = placeData.category.split('>').pop().trim();
            } else if (placeData.category === 'ë§›ì§‘') {
                placeData.category = 'ê¸°íƒ€';
            }
            try {
                const response = await fetch('/api/lunchmatches', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(placeData),
                });
                if (response.status === 201) alert(`'${place.place_name}' ë§›ì§‘ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                else if (response.status === 409) alert(await response.text());
                else throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
            } catch (error) {
                console.error('ë§›ì§‘ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                alert('ë§›ì§‘ì„ ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function removeAllChildNods(el) { while (el.hasChildNodes()) el.removeChild(el.lastChild); }

        // â–¼â–¼â–¼ ì „ì²´ ì§€ë„ ë³´ê¸° JavaScript í•¨ìˆ˜ ì¶”ê°€ â–¼â–¼â–¼
        function openFullScreenMap() {
            const modal = document.getElementById('fullscreen-map-modal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            const mapContainer = document.getElementById('fullscreen-map');
            if (!modalMap) {
                modalMap = new kakao.maps.Map(mapContainer, {
                    center: map.getCenter(),
                    level: map.getLevel()
                });
            }
            setTimeout(() => {
                modalMap.relayout();
                modalMap.setCenter(map.getCenter());
                modalMap.setLevel(map.getLevel());
                markers.forEach(marker => {
                    new kakao.maps.Marker({
                        map: modalMap, position: marker.getPosition(),
                        image: marker.getImage()
                    });
                });
                if (myLocationMarker) {
                    new kakao.maps.Marker({
                        map: modalMap, position: myLocationMarker.getPosition(),
                        image: myLocationMarker.getImage()
                    });
                }
            }, 100);
        }

        function closeFullScreenMap() {
            const modal = document.getElementById('fullscreen-map-modal');
            modal.classList.add('opacity-0', 'pointer-events-none');

            document.getElementById('fullscreen-map').innerHTML = '';
            modalMap = null;

            if (modalMyLocationMarker) {
                modalMyLocationMarker.setMap(null);
                modalMyLocationMarker = null;
            }
            // [ì¶”ê°€] ëª¨ë‹¬ì˜ ì›ë„ í•¨ê»˜ ì œê±°í•©ë‹ˆë‹¤.
            if (modalMyLocationCircle) {
                modalMyLocationCircle.setMap(null);
                modalMyLocationCircle = null;
            }
        }
        function displayMyLocationOnModal() {
            if (!modalMap) return;

            if (navigator.geolocation) {
                const geoOptions = { /* ... */ };

                navigator.geolocation.getCurrentPosition(position => {
                    const locPosition = new kakao.maps.LatLng(position.coords.latitude, position.coords.longitude);

                    // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
                    if (modalMyLocationMarker) {
                        modalMyLocationMarker.setMap(null);
                    }
                    // [ì¶”ê°€] ê¸°ì¡´ ì› ì œê±°
                    if (modalMyLocationCircle) {
                        modalMyLocationCircle.setMap(null);
                    }

                    // ìƒˆë¡œìš´ ë§ˆì»¤ ìƒì„±
                    modalMyLocationMarker = new kakao.maps.Marker({
                        map: modalMap,
                        position: locPosition,
                        image: new kakao.maps.MarkerImage('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png', new kakao.maps.Size(24, 35), {offset: new kakao.maps.Point(12, 35)})
                    });

                    // [ì¶”ê°€] ìƒˆë¡œìš´ ì› ìƒì„±
                    modalMyLocationCircle = new kakao.maps.Circle({
                        map: modalMap,
                        center: locPosition,
                        radius: currentSearchRadius,
                        strokeWeight: 2,
                        strokeColor: '#004CFF',
                        strokeOpacity: 0.8,
                        strokeStyle: 'dashed',
                        fillColor: '#CCE7FF',
                        fillOpacity: 0.5
                    });

                    modalMap.setCenter(locPosition);
                }, () => { /* ... */ }, geoOptions);
            } else { /* ... */ }
        }


    </script>
</th:block>
</html>