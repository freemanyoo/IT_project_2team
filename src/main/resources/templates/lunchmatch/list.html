<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" style="height: 100%;">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë¶€ì‚° ë§›ì§‘ ì°¾ì•„ë– ë‚˜ê¸° (ì§€ë„ ì—°ë™)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=8318dbdbe87b39e59f31a321d6143d23&libraries=services"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body { font-family: 'Noto Sans KR', 'Inter', sans-serif; display: flex; flex-direction: column; }
    .card-fade-in { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    #fullscreen-map-modal {
      transition: opacity 0.3s ease-in-out;
    }
    #map {
      width: 100%;
      height: 600px;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      overflow: hidden;
    }
    /* ì¸í¬ìœˆë„ìš° ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    .info {
      padding: 5px;
      border-radius: 5px;
      background: #fff;
      border: 1px solid #ccc;
      box-shadow: 0 2px 2px rgba(0,0,0,0.1);
      white-space: nowrap;
    }
    .info .title {
      font-weight: bold;
      font-size: 14px;
      color: #333;
    }
    /* í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
    .highlighted {
      background-color: #e0f2fe !important; /* Tailwind bg-blue-100 */
    }
  </style>
</head>
<body class="bg-gray-50">

<div class="container mx-auto p-4 md:p-8 max-w-7xl flex flex-col flex-grow">
  <header class="text-center my-8 flex-shrink-0">
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-4xl md:text-5xl font-bold text-gray-800">
        ë‚´ê°€ ì €ì¥í•œ ë§›ì§‘ ğŸ±
      </h1>
      <a href="/lunchmatch/map" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-300">
        ì§€ë„ì—ì„œ ë§›ì§‘ ì°¾ê¸°
      </a>
    </div>
    <p class="text-gray-500 mt-2">ì €ì¥í•œ ë§›ì§‘ë“¤ì„ ì§€ë„ì™€ í•¨ê»˜ ë§Œë‚˜ë³´ì„¸ìš”!</p>
  </header>

  <main class="grid grid-cols-1 lg:grid-cols-2 gap-8 flex-grow min-h-0">
    <div class="flex flex-col h-full overflow-hidden">
      <div class="bg-white p-4 rounded-lg shadow-md mb-6 flex-shrink-0">
        <form id="searchForm" onsubmit="event.preventDefault(); fetchRestaurantsAndDisplay();" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
          <div class="md:col-span-2">
            <label for="keyword" class="block text-sm font-medium text-gray-700">ê²€ìƒ‰ì–´ (ì´ë¦„ ë˜ëŠ” ì£¼ì†Œ)</label>
            <input type="text" id="keyword" name="keyword" th:value="${keyword}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
          </div>
          <div>
            <label for="category" class="block text-sm font-medium text-gray-700">ìŒì‹ ì¢…ë¥˜</label>
            <select id="category" name="category" onchange="fetchRestaurantsAndDisplay()" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
              <option value="">ì „ì²´</option>
              <option value="í•œì‹" th:selected="${category == 'í•œì‹'}">í•œì‹</option>
              <option value="ì¤‘ì‹" th:selected="${category == 'ì¤‘ì‹'}">ì¤‘ì‹</option>
              <option value="ì¼ì‹" th:selected="${category == 'ì¼ì‹'}">ì¼ì‹</option>
              <option value="ì–‘ì‹" th:selected="${category == 'ì–‘ì‹'}">ì–‘ì‹</option>
              <option value="ì¹´í˜" th:selected="${category == 'ì¹´í˜'}">ì¹´í˜</option>
              <option value="ë¶„ì‹" th:selected="${category == 'ë¶„ì‹'}">ë¶„ì‹</option>
            </select>
          </div>
          <div>
            <label for="orderBy" class="block text-sm font-medium text-gray-700">ì •ë ¬ ê¸°ì¤€</label>
            <select id="orderBy" name="orderBy" onchange="applySortingAndDisplay()" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
              <option value="latest" th:selected="${orderBy == 'latest'}">ìµœì‹ ìˆœ</option>
              <option value="name" th:selected="${orderBy == 'name'}">ì´ë¦„ìˆœ</option>
              <option value="rating_desc" th:selected="${orderBy == 'rating_desc'}">í‰ì  ë†’ì€ ìˆœ</option>
              <option value="distance" th:selected="${orderBy == 'distance'}">ê±°ë¦¬ìˆœ</option>
            </select>
          </div>
          <div>
            <button type="submit" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition duration-300">
              ê²€ìƒ‰í•˜ê¸°
            </button>
          </div>
        </form>
      </div>

      <div class="border-t border-gray-200 pt-8 flex-grow overflow-y-auto">
        <h2 class="text-2xl font-semibold text-gray-700 mb-6">âœ¨ ë§›ì§‘ ëª©ë¡</h2>
        <div id="restaurant-list" class="space-y-4">
        </div>
      </div>
    </div>

    <div class="relative rounded-lg shadow-md overflow-hidden" id="map-container">
      <div id="map"></div>
      <button onclick="openFullScreenMap()" class="absolute top-2 right-2 bg-white text-gray-700 font-semibold py-2 px-4 rounded-full shadow-lg z-10 hover:bg-gray-200 transition">
        ì „ì²´ ì§€ë„ ë³´ê¸°
      </button>
      <button onclick="displayMyLocation()" class="absolute top-14 right-2 bg-white p-2 rounded-full shadow-lg z-10 hover:bg-gray-200">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
      </button>
      <div class="absolute top-2 left-2 z-10">
        <label for="radiusSelect" class="sr-only">ë°˜ê²½ ì„ íƒ</label>
        <select id="radiusSelect" onchange="changeSearchRadius()" class="bg-white text-gray-700 text-sm py-2 px-3 rounded-md shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="500">500m</option>
          <option value="1000">1km</option>
          <option value="2000">2km</option>
          <option value="5000">5km</option>
          <option value="10000">10km</option>
        </select>
      </div>
    </div>
  </main>
</div>

<div id="fullscreen-map-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center opacity-0 pointer-events-none">
  <div class="relative w-11/12 h-5/6 bg-white rounded-lg shadow-2xl p-4">
    <div id="fullscreen-map" class="w-full h-full rounded-lg"></div>
    <button onclick="closeFullScreenMap()" class="absolute top-4 right-4 bg-white text-gray-800 font-bold py-2 px-4 rounded-full shadow-xl hover:bg-gray-200 transition z-10">
      ë‹«ê¸°
    </button>
  </div>
</div>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=8318dbdbe87b39e59f31a321d6143d23&libraries=services"></script>
<script>
  let map;
  let modalMap;
  let markers = []; // ë§›ì§‘ ë§ˆì»¤ë“¤ì„ ê´€ë¦¬í•˜ëŠ” ë°°ì—´
  let infowindow = new kakao.maps.InfoWindow({zIndex:1}); // ë‹¨ì¼ ì •ë³´ì°½ ì¸ìŠ¤í„´ìŠ¤

  let userLocation = null;
  let myLocationMarker = null; // ë‚´ ìœ„ì¹˜ ë§ˆì»¤
  let myLocationCircle = null; // ë‚´ ìœ„ì¹˜ ë°˜ê²½ ì›
  let currentSearchRadius = 500;

  let currentActiveMarker = null; // í˜„ì¬ ì§€ë„ì—ì„œ í™œì„±í™”ëœ ë§ˆì»¤ (ë§ˆìš°ìŠ¤ ì˜¤ë²„/í´ë¦­)

  let restaurantsFromServer = []; // AJAXë¡œ ë°›ì•„ì˜¨ ë§›ì§‘ ë°ì´í„°

  document.addEventListener('DOMContentLoaded', () => {
    console.log('DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ.');

    const mapContainer = document.getElementById('map');
    const mapOption = {
      center: new kakao.maps.LatLng(35.1795543, 129.0756416), // ì´ˆê¸° ì§€ë„ ì¤‘ì‹¬ (ë¶€ì‚°ì‹œì²­)
      level: 5 // ì´ˆê¸° ì§€ë„ í™•ëŒ€ ë ˆë²¨
    };
    map = new kakao.maps.Map(mapContainer, mapOption);

    // í˜ì´ì§€ ë¡œë“œ ì‹œ, ë°±ì—”ë“œ APIë¥¼ í˜¸ì¶œí•˜ì—¬ ë§›ì§‘ ëª©ë¡ì„ ê°€ì ¸ì™€ í‘œì‹œí•©ë‹ˆë‹¤.
    fetchRestaurantsAndDisplay();
  });

  // ë§›ì§‘ ëª©ë¡ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ë° í‘œì‹œ (ë©”ì¸ ë¡œì§)
  async function fetchRestaurantsAndDisplay() {
    const keyword = document.getElementById('keyword').value;
    const category = document.getElementById('category').value;
    const orderBy = document.getElementById('orderBy').value;
    const minRating = null;

    const queryParams = new URLSearchParams({
      keyword: keyword,
      category: category,
      orderBy: orderBy === 'distance' ? 'latest' : orderBy, // 'distance'ëŠ” í´ë¼ì´ì–¸íŠ¸ ì •ë ¬ì´ë¯€ë¡œ ì„œë²„ì—ëŠ” 'latest'ë¡œ ìš”ì²­
    }).toString();

    try {
      const response = await fetch(`/lunchmatch/api/list?${queryParams}`); // ë°±ì—”ë“œ API í˜¸ì¶œ
      if (!response.ok) {
        const errorText = await response.text();
        console.error('ë§›ì§‘ ëª©ë¡ API ì„œë²„ í˜¸ì¶œ ì‹¤íŒ¨:', response.status, errorText);
        throw new Error(`ë§›ì§‘ ëª©ë¡ API ì„œë²„ í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
      }
      restaurantsFromServer = await response.json(); // JSON ë°ì´í„°ë¥¼ ë³€ìˆ˜ì— í• ë‹¹
      console.log('--- Debug: fetch í›„ restaurantsFromServer ê°’ (AJAX ì‘ë‹µ) ---', restaurantsFromServer);

      // ë°ì´í„°ê°€ ì¤€ë¹„ë˜ë©´ ì •ë ¬ì„ ì ìš©í•˜ê³  ì§€ë„ ë° ëª©ë¡ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
      applySortingAndDisplay(); // ì´ í•¨ìˆ˜ ë‚´ì—ì„œ setMarkersOnMapê³¼ displayRestaurantListHtml í˜¸ì¶œ

      // ë§›ì§‘ì´ ìˆì„ ê²½ìš°, ëª¨ë“  ë§ˆì»¤ë¥¼ í¬í•¨í•˜ëŠ” ì§€ë„ë¡œ ì´ë™
      if (restaurantsFromServer.length > 0) {
        const bounds = new kakao.maps.LatLngBounds();
        restaurantsFromServer.forEach(resto => {
          if (typeof resto.latitude === 'number' && typeof resto.longitude === 'number' && resto.latitude !== null && resto.longitude !== null) {
            bounds.extend(new kakao.maps.LatLng(resto.latitude, resto.longitude));
          }
        });
        if (!bounds.isEmpty()) {
          map.setBounds(bounds);
        }
      }

    } catch (error) {
      console.error('ë§›ì§‘ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê±°ë‚˜ í‘œì‹œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
      alert('ë§›ì§‘ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
      restaurantsFromServer = [];
      setMarkersOnMap([], map); // ì§€ë„ì—ì„œë„ ë§ˆì»¤ ì œê±°
      document.getElementById('restaurant-list').innerHTML = '<div class="text-center py-12"><p class="text-lg text-gray-500">ë§›ì§‘ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p></div>';
    }
  }

  // ì •ë ¬ ì ìš© ë° ì§€ë„/ëª©ë¡ ì—…ë°ì´íŠ¸
  function applySortingAndDisplay() {
    const sortCriteria = document.getElementById('orderBy').value;
    let processedRestaurants = [...restaurantsFromServer]; // ì›ë³¸ ë°ì´í„° ë³µì‚¬

    if (sortCriteria === 'distance') {
      getUserLocation((errorOccurred) => {
        if (errorOccurred) {
          document.getElementById('orderBy').value = 'latest';
          alert("ê±°ë¦¬ìˆœ ì •ë ¬ì„ ìœ„í•´ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬í•©ë‹ˆë‹¤.");
          applySortingAndDisplay();
          return;
        }
        updateRestaurantDistances(processedRestaurants);
        processedRestaurants.sort((a, b) => {
          // ê±°ë¦¬ê°€ nullì´ê±°ë‚˜ NaNì¸ ê²½ìš°ë¥¼ ë§¨ ë’¤ë¡œ ë³´ëƒ„
          if (a.distance === null || isNaN(a.distance)) return 1;
          if (b.distance === null || isNaN(b.distance)) return -1;
          return a.distance - b.distance;
        });

        console.log('--- Debug: ê±°ë¦¬ìˆœ ì •ë ¬ í›„ ë§›ì§‘ ëª©ë¡:', processedRestaurants);

        setMarkersOnMap(processedRestaurants, map);
        displayRestaurantListHtml(processedRestaurants);
      });
    } else {
      if (sortCriteria === 'name') {
        processedRestaurants.sort((a, b) => a.name.localeCompare(b.name));
      } else if (sortCriteria === 'rating_desc') {
        processedRestaurants.sort((a, b) => {
          const ratingA = a.rating === null ? -1 : a.rating;
          const ratingB = b.rating === null ? -1 : b.rating;
          return ratingB - ratingA;
        });
      }

      setMarkersOnMap(processedRestaurants, map);
      displayRestaurantListHtml(processedRestaurants);
    }
  }


  // ë§›ì§‘ ëª©ë¡ì„ HTMLë¡œ ë™ì ìœ¼ë¡œ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
  function displayRestaurantListHtml(restaurants) {
    const listEl = document.getElementById('restaurant-list');
    while (listEl.firstChild) {
      listEl.removeChild(listEl.firstChild);
    }

    if (!restaurants || restaurants.length === 0) {
      listEl.innerHTML = '<div class="text-center py-12"><p class="text-lg text-gray-500">ì¡°ê±´ì— ë§ëŠ” ë§›ì§‘ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>';
      return;
    }

    restaurants.forEach((match, index) => {
      const el = document.createElement('div');
      el.className = `bg-white rounded-lg shadow-md overflow-hidden transform hover:shadow-xl transition-shadow duration-300 card-fade-in flex`;
      el.style.animationDelay = `${index * 100}ms`;
      el.dataset.rno = match.rno;

      let categoryParts = ['ë§›ì§‘'];
      if (match.category) {
        const parts = match.category.split('>');
        if (parts.length > 0) {
          categoryParts = [parts[parts.length - 1].trim()];
        }
      }
      const imageText = categoryParts[0];

      // ê±°ë¦¬ ì •ë³´ëŠ” updateRestaurantDistancesì—ì„œ ì´ë¯¸ match ê°ì²´ì— distance ì†ì„±ìœ¼ë¡œ ì¶”ê°€ë˜ì–´ ìˆìŒ
      const distanceDisplay = (match.distance !== undefined && match.distance !== null && !isNaN(match.distance)) ?
              `<span class="text-xs font-semibold ${match.distance * 1000 <= currentSearchRadius ? 'text-red-500' : 'text-blue-500'}">ê±°ë¦¬: ${match.distance.toFixed(2)}km</span>` :
              '<span class="text-xs text-gray-500">ê±°ë¦¬: ê³„ì‚° ë¶ˆê°€</span>';

      el.innerHTML = `
            <div class="w-32 h-32 bg-gray-200 flex-shrink-0 flex items-center justify-center">
              <span class="text-gray-500 text-lg font-bold">${imageText}</span>
            </div>
            <div class="p-4 flex flex-col justify-between flex-grow">
              <div>
                <div class="flex justify-between items-start">
                  <h3 class="text-lg font-semibold text-gray-800">${match.name}</h3>
                  ${match.rating != null ? `<span class="text-sm font-bold text-yellow-500 flex-shrink-0 ml-2">â­ ${match.rating}</span>` : ''}
                </div>
                <p class="text-sm text-gray-600 mt-1">${match.address}</p>
                ${distanceDisplay}
              </div>
              <div class="mt-2 text-right">
                <a href="/lunchmatch/read/${match.rno}" class="text-sm bg-blue-500 text-white py-1 px-3 rounded-md hover:bg-blue-600 transition-colors">
                  ìƒì„¸ë³´ê¸°
                </a>
              </div>
            </div>
          `;
      listEl.appendChild(el);

      el.onmouseover = () => {
        const targetMarker = markers.find(m => m.placeRno === match.rno);
        if (targetMarker) {
          if (currentActiveMarker && currentActiveMarker !== targetMarker) {
            currentActiveMarker.setImage(currentActiveMarker.normalImage);
          }
          targetMarker.setImage(targetMarker.hoverImage);
          infowindow.setContent(`<div class="info"><div class="title">${match.name}</div></div>`);
          infowindow.open(map, targetMarker); // map ëŒ€ì‹  targetMapìœ¼ë¡œ ìˆ˜ì • (ì „ì²´ ì§€ë„ ë³´ê¸°ì‹œ)
        }
      };
      el.onmouseout = () => {
        const targetMarker = markers.find(m => m.placeRno === match.rno);
        if (targetMarker && currentActiveMarker !== targetMarker) {
          targetMarker.setImage(targetMarker.normalImage);
          infowindow.close();
        }
      };
      el.onclick = (event) => {
        if (event.target.tagName === 'BUTTON' || event.target.closest('a')) return;

        const targetMarker = markers.find(m => m.placeRno === match.rno);
        if (targetMarker) {
          if (currentActiveMarker && currentActiveMarker !== targetMarker) {
            currentActiveMarker.setImage(currentActiveMarker.normalImage);
          }
          targetMarker.setImage(targetMarker.hoverImage);
          currentActiveMarker = targetMarker;
          map.panTo(targetMarker.getPosition());
          infowindow.setContent(`<div class="info"><div class="title">${match.name}</div></div>`);
          infowindow.open(map, targetMarker);
          highlightListItem(match.rno); // ëª©ë¡ í•˜ì´ë¼ì´íŠ¸
        }
      };
    });
  }


  function setMarkersOnMap(restaurants, targetMap) {
    for (let i = 0; i < markers.length; i++) {
      markers[i].setMap(null);
    }
    markers = [];
    currentActiveMarker = null;
    infowindow.close();

    console.log('--- Debug: setMarkersOnMap í˜¸ì¶œë¨. ì „ë‹¬ëœ ë§›ì§‘ ìˆ˜:', restaurants.length);
    console.log('--- Debug: setMarkersOnMap ì „ë‹¬ëœ ë§›ì§‘ ëª©ë¡:', restaurants);

    restaurants.forEach((resto, index) => {
      console.log('--- Debug: ê°œë³„ ë§›ì§‘ ê°ì²´ ë§ˆì»¤ ìƒì„± ì‹œë„:', resto);
      if (typeof resto.latitude === 'number' && typeof resto.longitude === 'number' && resto.latitude !== null && resto.longitude !== null) {
        const coords = new kakao.maps.LatLng(resto.latitude, resto.longitude);

        const normalImageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_number_blue.png';
        const imageSize = new kakao.maps.Size(36, 37);
        const normalImgOptions = { spriteSize: new kakao.maps.Size(36, 691), spriteOrigin: new kakao.maps.Point(0, (index < 10 ? index * 46 + 10 : 0)), offset: new kakao.maps.Point(13, 37) };
        const markerImageNormal = new kakao.maps.MarkerImage(normalImageSrc, imageSize, normalImgOptions);

        const hoverImageSrc = 'http://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png';
        const hoverImageSize = new kakao.maps.Size(31, 35);
        const hoverImgOptions = { offset: new kakao.maps.Point(13, 34) };
        const markerImageHover = new kakao.maps.MarkerImage(hoverImageSrc, hoverImageSize, hoverImgOptions);

        const marker = new kakao.maps.Marker({
          position: coords,
          image: markerImageNormal
        });
        marker.normalImage = markerImageNormal;
        marker.hoverImage = markerImageHover;
        marker.placeRno = resto.rno;
        marker.placeName = resto.name;

        marker.setMap(targetMap);
        markers.push(marker);

        kakao.maps.event.addListener(marker, 'mouseover', () => {
          if (currentActiveMarker && currentActiveMarker !== marker) {
            currentActiveMarker.setImage(currentActiveMarker.normalImage);
          }
          marker.setImage(marker.hoverImage);
          infowindow.setContent(`<div class="info"><div class="title">${marker.placeName}</div></div>`);
          infowindow.open(targetMap, marker);
        });
        kakao.maps.event.addListener(marker, 'mouseout', () => {
          if (currentActiveMarker && currentActiveMarker !== marker) {
            currentActiveMarker = null;
            marker.setImage(marker.normalImage);
          }
          infowindow.close();
        });
        kakao.maps.event.addListener(marker, 'click', () => {
          if (currentActiveMarker && currentActiveMarker !== marker) {
            currentActiveMarker.setImage(currentActiveMarker.normalImage);
          }
          marker.setImage(marker.hoverImage);
          currentActiveMarker = marker;
          map.panTo(marker.getPosition());
          infowindow.setContent(`<div class="info"><div class="title">${marker.placeName}</div></div>`);
          infowindow.open(targetMap, marker);
          highlightListItem(marker.placeRno);
        });

      } else {
        console.warn('--- Debug: ë§›ì§‘ ë°ì´í„°ì— ìœ íš¨í•œ ìœ„ë„/ê²½ë„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë§ˆì»¤ ìƒì„± ê±´ë„ˆëœ€:', resto.name, 'ìœ„ë„:', resto.latitude, 'ê²½ë„:', resto.longitude);
      }
    });
  }

  function highlightListItem(rno) {
    document.querySelectorAll('#restaurant-list .highlighted').forEach(el => {
      el.classList.remove('highlighted');
      el.style.backgroundColor = '';
    });
    const itemEl = document.querySelector(`#restaurant-list div[data-rno="${rno}"]`);
    if (itemEl) {
      itemEl.classList.add('highlighted');
      itemEl.style.backgroundColor = '#e0f2fe';
      itemEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  }


  function getUserLocation(callback) {
    if (userLocation) {
      if (callback) callback();
      return;
    }
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(position => {
        userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
        if (callback) callback();
      }, error => {
        console.error("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", error);
        alert("í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ì •ë³´ ì ‘ê·¼ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
        if (callback) callback(true);
      }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
    } else {
      alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” Geolocationì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      if (callback) callback(true);
    }
  }

  function displayMyLocation() {
    getUserLocation((errorOccurred) => {
      if (!errorOccurred && userLocation) {
        const locPosition = new kakao.maps.LatLng(userLocation.lat, userLocation.lng);

        if (myLocationMarker) myLocationMarker.setMap(null);
        if (myLocationCircle) myLocationCircle.setMap(null);

        myLocationMarker = new kakao.maps.Marker({
          map: map,
          position: locPosition,
          image: new kakao.maps.MarkerImage(
                  'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png',
                  new kakao.maps.Size(24, 35),
                  { offset: new kakao.maps.Point(12, 35) }
          )
        });

        myLocationCircle = new kakao.maps.Circle({
          map: map,
          center: locPosition,
          radius: currentSearchRadius,
          strokeWeight: 2,
          strokeColor: '#004CFF',
          strokeOpacity: 0.8,
          strokeStyle: 'dashed',
          fillColor: '#CCE7FF',
          fillOpacity: 0.5
        });

        map.setCenter(locPosition);
        map.setLevel(calculateLevelForRadius(currentSearchRadius));

        const infowindow = new kakao.maps.InfoWindow({
          content: '<div style="padding:5px;font-size:12px;">í˜„ì¬ ë‚´ ìœ„ì¹˜</div>',
          position: locPosition
        });
        infowindow.open(map, myLocationMarker);

        updateRestaurantDistances(restaurantsFromServer);
      }
    });
  }

  function changeSearchRadius() {
    currentSearchRadius = parseInt(document.getElementById('radiusSelect').value);
    if (userLocation) {
      displayMyLocation();
    }
  }

  function calculateLevelForRadius(radius) {
    if (radius <= 500) return 4;
    if (radius <= 1000) return 5;
    if (radius <= 2000) return 6;
    if (radius <= 5000) return 7;
    if (radius <= 10000) return 8;
    return 9;
  }

  function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = deg2rad(lat2 - lat1);
    const dLon = deg2rad(lon2 - lon1);
    const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }
  function deg2rad(deg) { return deg * (Math.PI / 180); }

  function updateRestaurantDistances(restaurants) {
    console.log('--- Debug: updateRestaurantDistances í˜¸ì¶œë¨. ëŒ€ìƒ ë§›ì§‘ ìˆ˜:', restaurants.length);
    if (!userLocation) {
      console.log('--- Debug: userLocationì´ ì—†ì–´ ê±°ë¦¬ ì—…ë°ì´íŠ¸ ê±´ë„ˆëœ€.');
      // HTML ìš”ì†Œì— ê±°ë¦¬ ì •ë³´ë¥¼ ìˆ¨ê¸°ê±°ë‚˜ ì§€ìš°ê¸°
      document.querySelectorAll('#restaurant-list .distance-info').forEach(itemEl => {
        itemEl.textContent = '';
        itemEl.style.fontWeight = 'normal';
        itemEl.style.color = 'inherit';
      });
      return restaurants; // userLocation ì—†ìœ¼ë©´ ì›ë³¸ ë°°ì—´ ê·¸ëŒ€ë¡œ ë°˜í™˜
    }

    restaurants.forEach(resto => {
      const lat = parseFloat(resto.latitude);
      const lng = parseFloat(resto.longitude);

      console.log(`--- Debug: ${resto.name} - ìœ„ë„: ${resto.latitude}, ê²½ë„: ${resto.longitude} -> íŒŒì‹± í›„: ${lat}, ${lng}`);

      if (!isNaN(lat) && !isNaN(lng)) {
        resto.distance = getDistance(userLocation.lat, userLocation.lng, lat, lng); // resto ê°ì²´ì— ì§ì ‘ distance ì†ì„± ì¶”ê°€

        // HTML ìš”ì†Œì— ê±°ë¦¬ ì •ë³´ ì—…ë°ì´íŠ¸ëŠ” displayRestaurantListHtmlì—ì„œ ë‹¤ì‹œ ë Œë”ë§ë  ë•Œ ë°˜ì˜ë¨
        // ì—¬ê¸°ì„œëŠ” ë°ì´í„° ê°ì²´ì—ë§Œ ì—…ë°ì´íŠ¸í•˜ê³  HTML ì—…ë°ì´íŠ¸ëŠ” displayRestaurantListHtmlì— ë§¡ê¹€
      } else {
        resto.distance = null; // ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ distanceë„ null
        console.warn('--- Debug: ë§›ì§‘ ë°ì´í„°ì— ìœ íš¨í•œ ìœ„ë„/ê²½ë„ ì •ë³´ê°€ ì—†ì–´ ê±°ë¦¬ ê³„ì‚° ê±´ë„ˆëœ€:', resto.name, 'ìœ„ë„:', resto.latitude, 'ê²½ë„:', resto.longitude);
      }
    });
    console.log('--- Debug: ê±°ë¦¬ ì—…ë°ì´íŠ¸ ì™„ë£Œ.');
    return restaurants; // ê±°ë¦¬ ì •ë³´ê°€ ì¶”ê°€ëœ ë°°ì—´ì„ ë°˜í™˜
  }

  function openFullScreenMap() {
    const modal = document.getElementById('fullscreen-map-modal');
    modal.classList.remove('opacity-0', 'pointer-events-none');
    const mapContainer = document.getElementById('fullscreen-map');

    if (!modalMap) {
      const mapOption = {
        center: map.getCenter(),
        level: map.getLevel()
      };
      modalMap = new kakao.maps.Map(mapContainer, mapOption);
    }

    setTimeout(() => {
      modalMap.relayout();
      setMarkersOnMap(restaurantsFromServer, modalMap);

      if(userLocation) {
        const locPosition = new kakao.maps.LatLng(userLocation.lat, userLocation.lng);
        new kakao.maps.Marker({
          map: modalMap,
          position: locPosition,
          image: new kakao.maps.MarkerImage(
                  'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png',
                  new kakao.maps.Size(24, 35),
                  { offset: new kakao.maps.Point(12, 35) }
          )
        });
        new kakao.maps.Circle({
          map: modalMap,
          center: locPosition,
          radius: currentSearchRadius,
          strokeWeight: 2,
          strokeColor: '#004CFF',
          strokeOpacity: 0.8,
          strokeStyle: 'dashed',
          fillColor: '#CCE7FF',
          fillOpacity: 0.5
        });
      }

      const allBounds = new kakao.maps.LatLngBounds();
      markers.forEach(marker => allBounds.extend(marker.getPosition()));
      if (userLocation) {
        allBounds.extend(new kakao.maps.LatLng(userLocation.lat, userLocation.lng));
      }
      if (!allBounds.isEmpty()) {
        modalMap.setBounds(allBounds);
      }

    }, 100);
  }

  function closeFullScreenMap() {
    const modal = document.getElementById('fullscreen-map-modal');
    modal.classList.add('opacity-0', 'pointer-events-none');
  }
</script>

</body>
</html>