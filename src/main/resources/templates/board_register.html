<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ëª¨ì§‘ê¸€ì“°ê¸° (ì§€ë„ ì—°ë™)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8f9fa; }
        .container-box { display: flex; margin-top: 30px; }
        .sidebar { width: 200px; margin-right: 30px; flex-shrink: 0; }
        .sidebar .menu { background-color: #ff7f50; color: white; padding: 10px; border-radius: 5px 5px 0 0; text-align: center; font-weight: bold; }
        .sidebar ul { list-style: none; padding-left: 0; background-color: #ffe2d5; margin: 0; border-radius: 0 0 5px 5px; }
        .sidebar ul li { margin: 0; padding: 10px 0; text-align: center; font-size: 0.95rem; border-bottom: 1px solid #f3c8b8; }
        .sidebar ul li:last-child { border-bottom: none; }
        .form-area { flex-grow: 1; }
        .form-area h2 { margin-bottom: 20px; }
        .form-control { margin-bottom: 15px; }
        .form-select { font-size: 0.9rem; }
        textarea.form-control { height: 150px; }
        .btn-area { display: flex; gap: 10px; margin-top: 20px; }
        .char-counter { font-size: 0.8rem; color: #6c757d; text-align: right; margin-top: -10px; margin-bottom: 10px; }
        .char-counter.over-limit { color: #dc3545; font-weight: bold; }

        /* ì§€ë„ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        #map-section { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; height: 450px; margin-bottom: 20px;}
        #map-controls { display: flex; flex-direction: column; overflow: hidden; }
        #placesList { list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; }
        #placesList li { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        #placesList li:hover { background-color: #f0f0f0; }
        #placesList .highlighted { background-color: #e0f2fe !important; font-weight: bold; }

        /* [ìˆ˜ì •] ì§€ë„ì™€ ì˜¤ë²„ë ˆì´ ë²„íŠ¼ë“¤ì„ ê°ì‹¸ëŠ” ë˜í¼ ìŠ¤íƒ€ì¼ */
        #map-wrapper { position: relative; width: 100%; height: 100%; }
        #map { width: 100%; height: 100%; border-radius: 8px; }

        .info .title { font-weight: bold; font-size: 14px; }
        #pagination { flex-shrink: 0; padding-top: 10px; }
        #pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="container">

<div class="container-box">
    <div class="sidebar">
        <div class="menu">ë©”ë‰´</div>
        <ul>
            <li><a href="#" style="text-decoration:none;">ì˜¤ì ë¨¸</a></li>
            <li><a href="#" style="text-decoration:none;">ë§›ì˜ì•Œëª¨ì§‘ì†Œ</a></li>
            <li><a href="#" style="text-decoration:none;">ì˜¤ì ì™„</a></li>
            <li><a href="#" style="text-decoration:none;">ë§›ì§‘ì •ë³´</a></li>
            <li><a href="#" style="text-decoration:none;">ì‹ ê³ ì„¼í„°</a></li>
            <li><a href="#" style="text-decoration:none;">MyPage</a></li>
            <li><a href="#" style="text-decoration:none;">ë§›ì§€ë„</a></li>
        </ul>
    </div>

    <div class="form-area">
        <h2>ëª¨ì§‘ ê²Œì‹œíŒ</h2>

        <form method="post" th:action="@{/board/register}" th:object="${board}" onsubmit="return validateForm()">
            <input type="text" id="title" name="title" class="form-control" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="100" th:field="*{title}">
            <div id="titleCounter" class="char-counter">0/100 bytes</div>
            <input type="text" id="writer" name="writer" class="form-control" placeholder="ì‘ì„±ìë¥¼ ì…ë ¥í•˜ì„¸ìš”" th:field="*{writer}">
            <hr class="my-4">

            <h5 class="mb-3">ğŸ“ ëª¨ì§‘ ì¥ì†Œ ì„ íƒ</h5>
            <div id="map-section">
                <div id="map-controls">
                    <div class="input-group mb-3">
                        <input type="text" id="keyword" class="form-control" placeholder="ì¥ì†Œ í‚¤ì›Œë“œ (ì˜ˆ: ë¶€ì‚° ì„œë©´ ë§›ì§‘)">
                        <button class="btn btn-outline-primary" type="button" onclick="performSearch(1)">ê²€ìƒ‰</button>
                    </div>
                    <ul id="placesList">
                        <li class="text-center text-muted p-5">ì¥ì†Œë¥¼ ê²€ìƒ‰í•´ì£¼ì„¸ìš”.</li>
                    </ul>
                    <div id="pagination" class="d-flex justify-content-between align-items-center mt-3">
                        <button id="prevBtn" class="btn btn-sm btn-outline-secondary" onclick="movePage(-1)" disabled>ì´ì „</button>
                        <span id="pageInfo" class="text-muted small"></span>
                        <button id="nextBtn" class="btn btn-sm btn-outline-secondary" onclick="movePage(1)" disabled>ë‹¤ìŒ</button>
                    </div>
                </div>
                <div id="map-wrapper">
                    <div id="map"></div>
                    <button type="button" onclick="displayMyLocation()" class="btn btn-light btn-sm position-absolute shadow-sm" style="top: 10px; right: 10px; z-index: 2;">
                        ë‚´ ìœ„ì¹˜
                    </button>
                    <select id="radiusSelect" onchange="changeSearchRadius()" class="form-select form-select-sm position-absolute shadow-sm" style="top: 10px; left: 10px; z-index: 2; width: auto;">
                        <option value="500" selected>500m</option>
                        <option value="1000">1km</option>
                        <option value="2000">2km</option>
                        <option value="5000">5km</option>
                    </select>
                </div>
            </div>
            <div class="alert alert-info" id="selectedLocationDisplay">ì„ íƒëœ ì¥ì†Œ: ì—†ìŒ</div>
            <input type="hidden" id="latitude" name="latitude" th:field="*{latitude}">
            <input type="hidden" id="longitude" name="longitude" th:field="*{longitude}">
            <input type="hidden" id="locationName" name="locationName" th:field="*{locationName}">
            <hr class="my-4">

            <input type="text" id="region" name="region" class="form-control" placeholder="ì£¼ìš” í™œë™ ì§€ì—­ (ì˜ˆ: ë¶€ì‚°ì§„êµ¬)" th:field="*{region}">
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">ì„±ë³„ ì œí•œ</label>
                    <select name="genderLimit" class="form-select" th:field="*{genderLimit}">
                        <option value="ì„±ë³„ìƒê´€ë¬´">ì„±ë³„ìƒê´€ë¬´</option>
                        <option value="ë‚¨">ë‚¨</option>
                        <option value="ì—¬">ì—¬</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">ìŒì‹ ì¹´í…Œê³ ë¦¬</label>
                    <select name="foodCategory" class="form-select" th:field="*{foodCategory}">
                        <option value="ì¢…ë¥˜ ì•ˆê°€ë¦¼">ì¢…ë¥˜ ì•ˆê°€ë¦¼</option>
                        <option value="í•œì‹">í•œì‹</option>
                        <option value="ì¤‘ì‹">ì¤‘ì‹</option>
                        <option value="ì¼ì‹">ì¼ì‹</option>
                        <option value="ë¶„ì‹">ë¶„ì‹</option>
                        <option value="ë””ì €íŠ¸">ë””ì €íŠ¸</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">ë§ˆê°ì‹œê°„</label>
                    <select id="deadlineHours" name="deadlineHours" class="form-select" required th:field="*{deadlineHours}">
                        <option value="">ì„ íƒ</option>
                        <option value="1">1ì‹œê°„ í›„</option>
                        <option value="2">2ì‹œê°„ í›„</option>
                        <option value="3">3ì‹œê°„ í›„</option>
                        <option value="24">24ì‹œê°„ í›„</option>
                    </select>
                </div>
            </div>
            <textarea id="content" name="content" class="form-control mt-3" placeholder="ëª¨ì§‘ê³¼ ê´€ë ¨ëœ ìƒì„¸ ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”" th:field="*{content}"></textarea>
            <div id="contentCounter" class="char-counter">0/2000 bytes</div>
            <div class="btn-area">
                <button type="submit" class="btn btn-success">ê²Œì‹œ ì™„ë£Œ</button>
                <a th:href="@{/board/list}" class="btn btn-secondary">ëª©ë¡ê°€ê¸°</a>
            </div>
        </form>
    </div>
</div>

<script th:src="|//dapi.kakao.com/v2/maps/sdk.js?appkey=${kakaoJsApiKey}&libraries=services|"></script>
<script>
    // ì§€ë„ APIì™€ ê´€ë ¨ ì—†ëŠ” í•¨ìˆ˜
    function getByteLength(str) { return new Blob([str], {type: 'text/plain'}).size; }
    function removeAllChildNods(el) { while (el.hasChildNodes()) el.removeChild(el.lastChild); }

    kakao.maps.load(function() {
        // --- ë³€ìˆ˜ ì„ ì–¸ ---
        let map;
        let markers = [];
        const infowindow = new kakao.maps.InfoWindow({zIndex:1, removable: true});
        const ps = new kakao.maps.services.Places();
        let searchedPlaces = [];
        let currentActiveMarker = null;
        let currentPage = 1, totalPage = 1;

        // [ì¶”ê°€] ë‚´ ìœ„ì¹˜ ê´€ë ¨ ë³€ìˆ˜
        let userLocation = null, myLocationMarker = null, myLocationCircle = null;
        let currentSearchRadius = 500;

        // --- ê¸°ëŠ¥ í•¨ìˆ˜ ---
        function initialize() {
            const mapContainer = document.getElementById('map');
            const mapOption = { center: new kakao.maps.LatLng(35.1576, 129.0594), level: 5 };
            map = new kakao.maps.Map(mapContainer, mapOption);

            document.getElementById('keyword').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    performSearch(1);
                }
            });
        }

        window.performSearch = async function(page) {
            currentPage = page;
            const keyword = document.getElementById('keyword').value.trim();
            if (!keyword) { alert('ì¥ì†Œ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }

            try {
                const response = await fetch(`/lunchmatch/searchKakaoPlaces?query=${encodeURIComponent(keyword)}&page=${page}`);
                if (!response.ok) throw new Error('ì„œë²„ API í˜¸ì¶œ ì‹¤íŒ¨');

                const data = await response.json();
                searchedPlaces = data.documents;
                displayPlaces(searchedPlaces);
                renderPagination(data.meta);

            } catch (error) {
                console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                alert('ì¥ì†Œ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function displayPlaces(places) {
            const listEl = document.getElementById('placesList');
            removeAllChildNods(listEl);
            removeMarker();
            if (!places || places.length === 0) {
                listEl.innerHTML = '<li class="text-center text-muted p-5">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
                return;
            }

            const bounds = new kakao.maps.LatLngBounds();
            places.forEach((place, i) => {
                const placePosition = new kakao.maps.LatLng(place.y, place.x);
                const marker = addMarker(placePosition, i, place.id);
                const itemEl = getListItem(i, place);

                bounds.extend(placePosition);

                itemEl.onmouseover = () => {
                    if (currentActiveMarker !== marker) marker.setImage(marker.hoverImage);
                    infowindow.setContent(`<div style="padding:5px;font-size:14px;">${place.place_name}</div>`);
                    infowindow.open(map, marker);
                };
                itemEl.onmouseout = () => {
                    if (currentActiveMarker !== marker) marker.setImage(marker.normalImage);
                    infowindow.close();
                };
                itemEl.onclick = () => {
                    if (currentActiveMarker && currentActiveMarker !== marker) {
                        currentActiveMarker.setImage(currentActiveMarker.normalImage);
                    }
                    marker.setImage(marker.hoverImage);
                    map.panTo(marker.getPosition());
                    currentActiveMarker = marker;
                    highlightListItem(place.id);
                };
                listEl.appendChild(itemEl);
            });
            map.setBounds(bounds);
        }

        function getListItem(index, place) {
            const el = document.createElement('li');
            el.dataset.placeId = place.id;
            el.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-0">${index + 1}. ${place.place_name}</h6>
                    <small class="text-muted">${place.road_address_name || place.address_name}</small>
                </div>
                <button type="button" class="btn btn-sm btn-success" onclick="event.stopPropagation(); selectPlace(${index});">ì„ íƒ</button>
            </div>`;
            return el;
        }

        function addMarker(position, idx, placeId) {
            const normalImageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_number_blue.png',
                hoverImageSrc = 'http://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png',
                imageSize = new kakao.maps.Size(36, 37),
                hoverImageSize = new kakao.maps.Size(31, 35);

            const normalImgOptions = { spriteSize: new kakao.maps.Size(36, 691), spriteOrigin: new kakao.maps.Point(0, (idx * 46) + 10), offset: new kakao.maps.Point(13, 37) };
            const markerImageNormal = new kakao.maps.MarkerImage(normalImageSrc, imageSize, normalImgOptions);
            const markerImageHover = new kakao.maps.MarkerImage(hoverImageSrc, hoverImageSize, { offset: new kakao.maps.Point(13, 34) });

            const marker = new kakao.maps.Marker({ position: position, image: markerImageNormal });
            marker.normalImage = markerImageNormal;
            marker.hoverImage = markerImageHover;
            marker.placeId = placeId;

            marker.setMap(map);
            markers.push(marker);
            return marker;
        }

        function removeMarker() {
            for (let i = 0; i < markers.length; i++) markers[i].setMap(null);
            markers = [];
            currentActiveMarker = null;
        }

        function highlightListItem(placeId) {
            document.querySelectorAll('#placesList li.highlighted').forEach(el => el.classList.remove('highlighted'));
            const itemEl = document.querySelector(`#placesList li[data-place-id="${placeId}"]`);
            if (itemEl) itemEl.classList.add('highlighted');
        }

        function renderPagination(meta) {
            const pageableCount = meta.pageable_count > 45 ? 45 : meta.pageable_count;
            totalPage = Math.ceil(pageableCount / 15);

            document.getElementById('pageInfo').textContent = `${currentPage} / ${totalPage}`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPage || meta.is_end;
        }

        window.movePage = function(delta) {
            const newPage = currentPage + delta;
            if (newPage > 0 && newPage <= totalPage) {
                performSearch(newPage);
            }
        }

        // [ì¶”ê°€] ë‚´ ìœ„ì¹˜ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function getUserLocation(callback) {
            if (userLocation) {
                callback(null, userLocation);
                return;
            }
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    userLocation = new kakao.maps.LatLng(position.coords.latitude, position.coords.longitude);
                    callback(null, userLocation);
                }, () => {
                    alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    callback(new Error("Geolocation failed."));
                });
            } else {
                alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” Geolocationì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                callback(new Error("Geolocation not supported."));
            }
        }

        window.displayMyLocation = function() {
            getUserLocation((err, locPosition) => {
                if (err) return;

                if (myLocationMarker) myLocationMarker.setMap(null);
                myLocationMarker = new kakao.maps.Marker({
                    map: map,
                    position: locPosition,
                    image: new kakao.maps.MarkerImage('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png', new kakao.maps.Size(24, 35))
                });

                if (myLocationCircle) myLocationCircle.setMap(null);
                myLocationCircle = new kakao.maps.Circle({
                    map: map,
                    center: locPosition,
                    radius: currentSearchRadius,
                    strokeWeight: 2,
                    strokeColor: '#004CFF',
                    fillColor: '#CCE7FF',
                    fillOpacity: 0.5
                });

                map.setCenter(locPosition);
                map.setLevel(calculateLevelForRadius(currentSearchRadius));
            });
        }

        window.changeSearchRadius = function() {
            currentSearchRadius = parseInt(document.getElementById('radiusSelect').value, 10);
            // ë‚´ ìœ„ì¹˜ê°€ í‘œì‹œëœ ìƒíƒœì—ì„œë§Œ ì›ì„ ì—…ë°ì´íŠ¸
            if (myLocationCircle) {
                myLocationCircle.setRadius(currentSearchRadius);
                map.setLevel(calculateLevelForRadius(currentSearchRadius));
            }
        }

        function calculateLevelForRadius(radius) {
            if (radius <= 500) return 4;
            if (radius <= 1000) return 5;
            if (radius <= 2000) return 6;
            return 7;
        }

        window.selectPlace = function(index) {
            const place = searchedPlaces[index];
            if (!place) return;

            // ìœ„ë„, ê²½ë„, ì¥ì†Œ ì´ë¦„ ë“± ê¸°ë³¸ ì •ë³´ ì±„ìš°ê¸°
            document.getElementById('latitude').value = place.y;
            document.getElementById('longitude').value = place.x;
            document.getElementById('locationName').value = place.place_name;

            // ì„ íƒëœ ì¥ì†Œ ì •ë³´ í™”ë©´ì— í‘œì‹œ
            const displayEl = document.getElementById('selectedLocationDisplay');
            displayEl.textContent = `ì„ íƒëœ ì¥ì†Œ: ${place.place_name} (${place.road_address_name || place.address_name})`;
            displayEl.classList.replace('alert-info', 'alert-success');

            // --- [í•µì‹¬ ìˆ˜ì •] ì£¼ìš” í™œë™ ì§€ì—­ì„ ë” ì •í™•í•˜ê²Œ ì¶”ì¶œí•˜ëŠ” ë¡œì§ ---
            const address = place.address_name; // ì˜ˆ: "ì„œìš¸ ì¢…ë¡œêµ¬ ê´€ì² ë™ 13-13" ë˜ëŠ” "ê²½ê¸° ìˆ˜ì›ì‹œ íŒ”ë‹¬êµ¬..."
            const addressParts = address.split(' '); // ê³µë°±ìœ¼ë¡œ ì£¼ì†Œ ë¶„ë¦¬

            // 'êµ¬' ë˜ëŠ” 'êµ°'ìœ¼ë¡œ ëë‚˜ëŠ” ì£¼ì†Œ ìš”ì†Œë¥¼ ì°¾ìŠµë‹ˆë‹¤.
            const regionPart = addressParts.find(part => part.endsWith('êµ¬') || part.endsWith('êµ°'));

            if (regionPart) {
                // 'OOêµ¬' ë˜ëŠ” 'OOêµ°'ì„ ì°¾ì€ ê²½ìš° (ëŒ€ë¶€ë¶„ì˜ ê²½ìš°)
                document.getElementById('region').value = regionPart;
            } else if (addressParts.length >= 2) {
                // 'êµ¬'/'êµ°'ì´ ì—†ëŠ” ë„ì‹œ(ì˜ˆ: ì œì£¼ì‹œ, ì„œê·€í¬ì‹œ)ë¥¼ ìœ„í•´ ë‘ ë²ˆì§¸ ìš”ì†Œë¥¼ ì°¨ì„ ì±…ìœ¼ë¡œ ì‚¬ìš©
                document.getElementById('region').value = addressParts[1];
            }
            // -----------------------------------------------------------------

            alert(`'${place.place_name}'ê°€ ëª¨ì§‘ ì¥ì†Œë¡œ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.`);
        };

        // --- ì´ˆê¸°í™” ì‹¤í–‰ ---
        initialize();
    });

    // --- ì§€ë„ì™€ ê´€ë ¨ ì—†ëŠ” ë¡œì§ ---
    const titleInput = document.getElementById('title');
    const contentInput = document.getElementById('content');
    const checkLength = (element, limit, counterId) => {
        const text = element.value;
        const byteLength = getByteLength(text);
        const counter = document.getElementById(counterId);
        counter.textContent = `${byteLength}/${limit} bytes`;
        counter.classList.toggle('over-limit', byteLength > limit);
    };
    titleInput.addEventListener('input', () => checkLength(titleInput, 100, 'titleCounter'));
    contentInput.addEventListener('input', () => checkLength(contentInput, 2000, 'contentCounter'));
    checkLength(titleInput, 100, 'titleCounter');
    checkLength(contentInput, 2000, 'contentCounter');

    window.validateForm = function() {
        // ìœ íš¨ì„± ê²€ì‚¬ ë¡œì§
        const fields = [
            { id: 'title', name: 'ì œëª©', limit: 100 },
            { id: 'content', name: 'ë³¸ë¬¸', limit: 2000 },
            { id: 'writer', name: 'ì‘ì„±ì' },
            { id: 'region', name: 'ì§€ì—­' },
            { id: 'deadlineHours', name: 'ë§ˆê°ì‹œê°„' }
        ];
        for (const field of fields) {
            const element = document.getElementById(field.id);
            if (!element.value.trim()) {
                alert(`${field.name}ì„(ë¥¼) ì…ë ¥í•˜ê±°ë‚˜ ì„ íƒí•´ì£¼ì„¸ìš”.`);
                element.focus();
                return false;
            }
            if (field.limit && getByteLength(element.value) > field.limit) {
                alert(`${field.name}ì€(ëŠ”) ${field.limit}ë°”ì´íŠ¸ë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                element.focus();
                return false;
            }
        }
        if (!document.getElementById('locationName').value) {
            alert('ì§€ë„ì—ì„œ ëª¨ì§‘ ì¥ì†Œë¥¼ ê²€ìƒ‰ í›„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return false;
        }
        return true;
    };
</script>
</body>
</html>