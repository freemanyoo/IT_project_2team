<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì‹œê¸€ ìˆ˜ì •</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8f9fa; }
        .container-box { display: flex; margin-top: 30px; }
        .sidebar { width: 200px; margin-right: 30px; flex-shrink: 0; }
        .sidebar .menu { background-color: #ff7f50; color: white; padding: 10px; border-radius: 5px 5px 0 0; text-align: center; font-weight: bold; }
        .sidebar ul { list-style: none; padding-left: 0; background-color: #ffe2d5; margin: 0; border-radius: 0 0 5px 5px; }
        .sidebar ul li { margin: 0; padding: 10px 0; text-align: center; font-size: 0.95rem; border-bottom: 1px solid #f3c8b8; }
        .sidebar ul li:last-child { border-bottom: none; }
        .form-area { flex-grow: 1; }
        .form-area h2 { margin-bottom: 20px; }
        .form-control { margin-bottom: 15px; }
        .form-select { font-size: 0.9rem; }
        textarea.form-control { height: 150px; }
        .btn-area { display: flex; gap: 10px; margin-top: 20px; }
        .char-counter { font-size: 0.8rem; color: #6c757d; text-align: right; margin-top: -10px; margin-bottom: 10px; }
        .char-counter.over-limit { color: #dc3545; font-weight: bold; }

        /* ì§€ë„ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        #map-section { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; height: 450px; margin-bottom: 15px;}
        #map-controls { display: flex; flex-direction: column; overflow: hidden; }
        #placesList { list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; border: 1px solid #dee2e6; border-radius: .25rem; }
        #placesList li { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        #placesList li:hover { background-color: #f0f0f0; }
        #placesList .highlighted { background-color: #e0f2fe !important; font-weight: bold; }
        #map-wrapper { position: relative; width: 100%; height: 100%; }
        #map { width: 100%; height: 100%; border-radius: 8px; }
        .info { padding: 5px; border-radius: 5px; background: #fff; border: 1px solid #ccc; white-space: nowrap; }
        .info .title { font-weight: bold; font-size: 14px; }
        #pagination { flex-shrink: 0; padding-top: 10px; }
        #pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="container">

<div class="container-box">


    <div class="form-area">
        <h2>ê²Œì‹œê¸€ ìˆ˜ì •</h2>
        <form method="post" th:action="@{/board/modify}" th:object="${board}" onsubmit="return validateForm()">
<!--            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />-->
            <input type="hidden" name="id" th:field="*{id}">
            <input type="text" id="title" name="title" class="form-control" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="100" th:field="*{title}">
            <div id="titleCounter" class="char-counter">0/100 bytes</div>

            <input type="text" id="writer" name="writer" class="form-control" th:field="*{writer}" readonly>
            <input type="text" id="region" name="region" class="form-control" placeholder="ì£¼ìš” í™œë™ ì§€ì—­ (ì˜ˆ: ë¶€ì‚°ì§„êµ¬)" th:field="*{region}">

            <div class="mt-3">
                <h5 class="mb-3">ğŸ“ ëª¨ì§‘ ì¥ì†Œ ìˆ˜ì •</h5>
                <div id="map-section">
                    <div id="map-controls">
                        <div class="input-group mb-3">
                            <input type="text" id="keyword" class="form-control" placeholder="ìƒˆë¡œìš´ ì¥ì†Œ ê²€ìƒ‰">
                            <button class="btn btn-outline-primary" type="button" onclick="performSearch(1)">ê²€ìƒ‰</button>
                        </div>
                        <ul id="placesList">
                            <li class="text-center text-muted p-5">
                                <strong>í˜„ì¬ ì„¤ì •ëœ ì¥ì†Œ</strong><br>
                                <small th:text="${board.locationName ?: 'ìƒˆë¡œìš´ ì¥ì†Œë¥¼ ê²€ìƒ‰í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”.'}"></small>
                            </li>
                        </ul>
                        <div id="pagination" class="d-flex justify-content-between align-items-center mt-3">
                            <button id="prevBtn" class="btn btn-sm btn-outline-secondary" onclick="movePage(-1)" disabled>ì´ì „</button>
                            <span id="pageInfo" class="text-muted small"></span>
                            <button id="nextBtn" class="btn btn-sm btn-outline-secondary" onclick="movePage(1)" disabled>ë‹¤ìŒ</button>
                        </div>
                    </div>
                    <div id="map-wrapper">
                        <div id="map"></div>
                        <button type="button" onclick="displayMyLocation()" class="btn btn-light btn-sm position-absolute shadow-sm" style="top: 10px; right: 10px; z-index: 2;">ë‚´ ìœ„ì¹˜</button>
                        <select id="radiusSelect" onchange="changeSearchRadius()" class="form-select form-select-sm position-absolute shadow-sm" style="top: 10px; left: 10px; z-index: 2; width: auto;">
                            <option value="500" selected>500m</option>
                            <option value="1000">1km</option>
                            <option value="2000">2km</option>
                            <option value="5000">5km</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="alert alert-info" id="selectedLocationDisplay">í˜„ì¬ ì¥ì†Œ: <span th:text="${board.locationName ?: 'ì—†ìŒ'}"></span></div>
            <input type="hidden" id="latitude" name="latitude" th:field="*{latitude}">
            <input type="hidden" id="longitude" name="longitude" th:field="*{longitude}">
            <input type="hidden" id="locationName" name="locationName" th:field="*{locationName}">

            <div class="row mt-3">
                <div class="col-md-4">
                    <label class="form-label">ì„±ë³„ ì œí•œ</label>
                    <select name="genderLimit" class="form-select" th:field="*{genderLimit}">
                        <option value="ì„±ë³„ìƒê´€ë¬´">ì„±ë³„ìƒê´€ë¬´</option>
                        <option value="ë‚¨">ë‚¨</option>
                        <option value="ì—¬">ì—¬</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">ìŒì‹ ì¹´í…Œê³ ë¦¬</label>
                    <select name="foodCategory" class="form-select" th:field="*{foodCategory}">
                        <option value="ì¢…ë¥˜ ì•ˆê°€ë¦¼">ì¢…ë¥˜ ì•ˆê°€ë¦¼</option>
                        <option value="í•œì‹">í•œì‹</option>
                        <option value="ì¤‘ì‹">ì¤‘ì‹</option>
                        <option value="ì¼ì‹">ì¼ì‹</option>
                        <option value="ë¶„ì‹">ë¶„ì‹</option>
                        <option value="ë””ì €íŠ¸">ë””ì €íŠ¸</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">ë§ˆê°ì‹œê°„</label>
                    <select id="deadlineHours" name="deadlineHours" class="form-select" th:field="*{deadlineHours}" required>
                        <option value="1">1ì‹œê°„ í›„</option>
                        <option value="2">2ì‹œê°„ í›„</option>
                        <option value="3">3ì‹œê°„ í›„</option>
                        <option value="24">24ì‹œê°„ í›„</option>
                    </select>
                </div>
            </div>

            <textarea id="content" name="content" class="form-control mt-3" placeholder="ë³¸ë¬¸ ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”" th:field="*{content}"></textarea>
            <div id="contentCounter" class="char-counter">0/2000 bytes</div>

            <div class="btn-area">
                <button type="submit" class="btn btn-success">ìˆ˜ì • ì™„ë£Œ</button>
                <a th:href="@{/board/read(id=${board.id})}" class="btn btn-secondary">ì·¨ì†Œ</a>
            </div>
        </form>
    </div>
</div>

<script th:src="|//dapi.kakao.com/v2/maps/sdk.js?appkey=${kakaoJsApiKey}&libraries=services|"></script>
<script th:inline="javascript">
    const boardData = {
        latitude: /*[[${board.latitude}]]*/ null,
        longitude: /*[[${board.longitude}]]*/ null,
        locationName: /*[[${board.locationName}]]*/ null
    };

    function getByteLength(str) { return new Blob([str], {type: 'text/plain'}).size; }
    function removeAllChildNods(el) { while (el.hasChildNodes()) el.removeChild(el.lastChild); }

    kakao.maps.load(function() {
        // --- ë³€ìˆ˜ ì„ ì–¸ ---
        let map, infowindow, ps;
        let mainMarker, myLocationMarker, myLocationCircle;
        let searchedMarkers = [], searchedPlaces = [], currentActiveMarker = null;
        let currentPage = 1, totalPage = 1;
        let userLocation = null, currentSearchRadius = 500;

        // --- ê¸°ëŠ¥ í•¨ìˆ˜ ---
        function initialize() {
            infowindow = new kakao.maps.InfoWindow({zIndex:1, removable: true});
            ps = new kakao.maps.services.Places();
            const mapContainer = document.getElementById('map');
            const mapOption = { center: new kakao.maps.LatLng(35.1576, 129.0594), level: 5 };
            map = new kakao.maps.Map(mapContainer, mapOption);

            // ê¸°ì¡´ ìœ„ì¹˜ê°€ ìˆìœ¼ë©´ ë©”ì¸ ë§ˆì»¤ë¡œ í‘œì‹œ
            if (boardData.latitude != null && boardData.longitude != null) {
                const mainPosition = new kakao.maps.LatLng(boardData.latitude, boardData.longitude);
                mainMarker = new kakao.maps.Marker({
                    position: mainPosition,
                    image: new kakao.maps.MarkerImage('http://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png', new kakao.maps.Size(31, 35))
                });
                mainMarker.setMap(map);
                map.setCenter(mainPosition);
            }

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
            document.getElementById('keyword').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); performSearch(1); }
            });
            const titleInput = document.getElementById('title');
            const contentInput = document.getElementById('content');
            titleInput.addEventListener('input', () => checkLength(titleInput, 100, 'titleCounter'));
            contentInput.addEventListener('input', () => checkLength(contentInput, 2000, 'contentCounter'));
            checkLength(titleInput, 100, 'titleCounter');
            checkLength(contentInput, 2000, 'contentCounter');
        }

        window.performSearch = async function(page) {
            currentPage = page;
            const keyword = document.getElementById('keyword').value.trim();
            if (!keyword) { alert('ì¥ì†Œ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }

            try {
                const response = await fetch(`/lunchmatch/searchKakaoPlaces?query=${encodeURIComponent(keyword)}&page=${page}`);
                if (!response.ok) throw new Error('ì„œë²„ API í˜¸ì¶œ ì‹¤íŒ¨');

                const data = await response.json();
                searchedPlaces = data.documents;
                displayPlaces(searchedPlaces);
                renderPagination(data.meta);
            } catch (error) {
                console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                alert('ì¥ì†Œ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function displayPlaces(places) {
            const listEl = document.getElementById('placesList');
            removeAllChildNods(listEl);
            clearSearchedMarkers();
            if (!places || places.length === 0) {
                listEl.innerHTML = '<li class="text-center text-muted p-5">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
                return;
            }

            const bounds = new kakao.maps.LatLngBounds();
            places.forEach((place, i) => {
                const placePosition = new kakao.maps.LatLng(place.y, place.x);
                const marker = addSearchedMarker(placePosition, i, place.id);
                const itemEl = getListItem(i, place);
                bounds.extend(placePosition);

                itemEl.onmouseover = () => {
                    if (currentActiveMarker !== marker) marker.setImage(marker.hoverImage);
                    infowindow.setContent(`<div class="info"><div class="title">${place.place_name}</div></div>`);
                    infowindow.open(map, marker);
                };
                itemEl.onmouseout = () => {
                    if (currentActiveMarker !== marker) marker.setImage(marker.normalImage);
                    infowindow.close();
                };
                itemEl.onclick = () => {
                    if (currentActiveMarker && currentActiveMarker !== marker) currentActiveMarker.setImage(currentActiveMarker.normalImage);
                    marker.setImage(marker.hoverImage);
                    map.panTo(marker.getPosition());
                    currentActiveMarker = marker;
                    highlightListItem(place.id);
                };
                listEl.appendChild(itemEl);
            });
            if(mainMarker) bounds.extend(mainMarker.getPosition());
            map.setBounds(bounds);
        }

        function getListItem(index, place) {
            const el = document.createElement('li');
            el.dataset.placeId = place.id;
            el.innerHTML = `
                <div class="d-flex justify-content-between align-items-center p-2">
                    <div>
                        <h6 class="mb-0">${index + 1}. ${place.place_name}</h6>
                        <small class="text-muted">${place.road_address_name || place.address_name}</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-success" onclick="event.stopPropagation(); selectPlace(${index});">ì„ íƒ</button>
                </div>`;
            return el;
        }

        function addSearchedMarker(position, idx, placeId) {
            const normalSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_number_blue.png';
            const hoverSrc = 'http://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png';
            const imageSize = new kakao.maps.Size(36, 37);
            const hoverSize = new kakao.maps.Size(31, 35);
            const normalOptions = { spriteSize: new kakao.maps.Size(36, 691), spriteOrigin: new kakao.maps.Point(0, (idx * 46) + 10), offset: new kakao.maps.Point(13, 37) };

            const marker = new kakao.maps.Marker({ position: position, image: new kakao.maps.MarkerImage(normalSrc, imageSize, normalOptions) });
            marker.normalImage = new kakao.maps.MarkerImage(normalSrc, imageSize, normalOptions);
            marker.hoverImage = new kakao.maps.MarkerImage(hoverSrc, hoverSize, { offset: new kakao.maps.Point(13, 34) });
            marker.placeId = placeId;
            marker.setMap(map);
            searchedMarkers.push(marker);
            return marker;
        }

        function clearSearchedMarkers() {
            searchedMarkers.forEach(m => m.setMap(null));
            searchedMarkers = [];
            currentActiveMarker = null;
        }

        function highlightListItem(placeId) {
            document.querySelectorAll('#placesList li.highlighted').forEach(el => el.classList.remove('highlighted'));
            const itemEl = document.querySelector(`#placesList li[data-place-id="${placeId}"]`);
            if (itemEl) itemEl.classList.add('highlighted');
        }

        function renderPagination(meta) {
            const pageableCount = meta.pageable_count > 45 ? 45 : meta.pageable_count;
            totalPage = Math.ceil(pageableCount / 15);
            document.getElementById('pageInfo').textContent = `${currentPage} / ${totalPage}`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPage || meta.is_end;
        }

        window.movePage = function(delta) {
            const newPage = currentPage + delta;
            if (newPage > 0 && newPage <= totalPage) { performSearch(newPage); }
        }

        function getUserLocation(callback) {
            if (userLocation) { callback(null, userLocation); return; }
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        userLocation = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
                        callback(null, userLocation);
                    },
                    () => { alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); callback(new Error("Geolocation failed.")); }
                );
            } else { alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” Geolocationì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); callback(new Error("Geolocation not supported.")); }
        }

        window.displayMyLocation = function() {
            getUserLocation((err, locPosition) => {
                if (err) return;
                if (myLocationMarker) myLocationMarker.setMap(null);
                myLocationMarker = new kakao.maps.Marker({ map: map, position: locPosition, image: new kakao.maps.MarkerImage('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png', new kakao.maps.Size(24, 35)) });
                if (myLocationCircle) myLocationCircle.setMap(null);
                myLocationCircle = new kakao.maps.Circle({ map: map, center: locPosition, radius: currentSearchRadius, strokeWeight: 2, strokeColor: '#004CFF', fillColor: '#CCE7FF', fillOpacity: 0.5 });
                const bounds = new kakao.maps.LatLngBounds();
                bounds.extend(locPosition);
                if (mainMarker) bounds.extend(mainMarker.getPosition());
                map.setBounds(bounds);
            });
        }

        window.changeSearchRadius = function() {
            currentSearchRadius = parseInt(document.getElementById('radiusSelect').value, 10);
            if (myLocationCircle) {
                myLocationCircle.setRadius(currentSearchRadius);
            }
        }

        window.selectPlace = function(index) {
            const place = searchedPlaces[index];
            if (!place) return;

            document.getElementById('latitude').value = place.y;
            document.getElementById('longitude').value = place.x;
            document.getElementById('locationName').value = place.place_name;

            const displayEl = document.getElementById('selectedLocationDisplay');
            displayEl.textContent = `ì„ íƒëœ ì¥ì†Œ: ${place.place_name} (${place.road_address_name || place.address_name})`;
            displayEl.classList.replace('alert-info', 'alert-success');

            if(mainMarker) mainMarker.setMap(null); // ê¸°ì¡´ ë©”ì¸ ë§ˆì»¤ ì œê±°
            const newMainPosition = new kakao.maps.LatLng(place.y, place.x);
            mainMarker = new kakao.maps.Marker({
                position: newMainPosition,
                image: new kakao.maps.MarkerImage('http://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png', new kakao.maps.Size(31, 35))
            });
            mainMarker.setMap(map);
            map.setCenter(newMainPosition);

            const address = place.address_name;
            const match = address.match(/(\S+[ì‹œ|ë„])\s(\S+[êµ¬|êµ°])/);
            if (match && match[2]) document.getElementById('region').value = match[2];
            alert(`'${place.place_name}'ê°€ ëª¨ì§‘ ì¥ì†Œë¡œ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.`);
        };

        // --- ê¸°ì¡´ í˜ì´ì§€ ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ ---
        const checkLength = (element, limit, counterId) => {
            const text = element.value;
            const byteLength = getByteLength(text);
            const counter = document.getElementById(counterId);
            counter.textContent = `${byteLength}/${limit} bytes`;
            counter.classList.toggle('over-limit', byteLength > limit);
        };

        window.validateForm = function() {
            const fields = [
                { id: 'title', name: 'ì œëª©', limit: 100 },
                { id: 'content', name: 'ë³¸ë¬¸', limit: 2000 },
                { id: 'writer', name: 'ì‘ì„±ì' },
                { id: 'region', name: 'ì§€ì—­' },
                { id: 'deadlineHours', name: 'ë§ˆê°ì‹œê°„' }
            ];
            for (const field of fields) {
                const element = document.getElementById(field.id);
                if (!element.value.trim()) {
                    alert(`${field.name}ì„(ë¥¼) ì…ë ¥í•˜ê±°ë‚˜ ì„ íƒí•´ì£¼ì„¸ìš”.`);
                    element.focus();
                    return false;
                }
                if (field.limit && getByteLength(element.value) > field.limit) {
                    alert(`${field.name}ì€(ëŠ”) ${field.limit}ë°”ì´íŠ¸ë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                    element.focus();
                    return false;
                }
            }
            if (!document.getElementById('locationName').value) {
                alert('ì§€ë„ì—ì„œ ëª¨ì§‘ ì¥ì†Œë¥¼ ê²€ìƒ‰ í›„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return false;
            }
            return true;
        };

        // --- ì´ˆê¸°í™” ì‹¤í–‰ ---
        initialize();
    });
</script>
</body>
</html>