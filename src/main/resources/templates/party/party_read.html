<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>파티 상세보기</title>

    <!-- ✅ CSRF 토큰 메타 태그로 저장 -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_parameter" th:content="${_csrf.parameterName}" />
</head>
<body>

<h1>파티 상세보기</h1>

<!-- 파티 정보 표시 -->
<div>
    <p>제목: <span th:text="${party.title}"></span></p>
    <p>작성자 ID: <span th:text="${party.writerId}"></span></p>
    <p>내용: <span th:text="${party.content}"></span></p>
    <p>카테고리: <span th:text="${party.foodCategory}"></span></p>
    <p>제한 성별: <span th:text="${party.genderLimit}"></span></p>
    <p>식사 시간:
        <span th:text="${#temporals.format(party.partyTime, 'yyyy-MM-dd HH:mm')}">모임 시간</span>
    </p>
    <p>파티 신청 마감 시간:
        <span th:text="${#temporals.format(party.deadline, 'yyyy-MM-dd HH:mm')}">마감 시간</span>
    </p>
</div>

<!-- 파티 수정/삭제 버튼 -->
<div style="margin-bottom: 20px;">
    <form th:action="@{/party/update}" method="get" style="display:inline;">
        <input type="hidden" name="id" th:value="${party.id}" />
        <button type="submit">글 수정</button>
    </form>

    <form th:action="@{/party/delete}" method="post" style="display:inline;" onsubmit="return confirm('정말 삭제하시겠습니까?');">
        <input type="hidden" name="id" th:value="${party.id}" />
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <button type="submit">글 삭제</button>
    </form>
</div>

<hr>

<!-- 댓글 목록 -->
<h3>댓글</h3>
<div th:each="comment : ${commentList}" th:id="'comment-' + ${comment.id}">
    <p>
        <span th:text="${comment.writerId}">작성자</span> :
        <span th:text="${comment.content}">내용</span>

        <!-- 수정 버튼: 필요한 필드 모두 포함 -->
        <button type="button"
                th:attr="data-id=${comment.id},
                         data-partyid=${comment.partyId},
                         data-content=${comment.content},
                         data-gender=${comment.gender},
                         data-writerid=${comment.writerId}"
                onclick="editComment(this)">
            수정
        </button>

        <!-- 삭제 버튼 -->
        <button type="button"
                th:onclick="'deleteComment(' + ${comment.id} + ',' + ${comment.partyId} + ')'">
            삭제
        </button>
    </p>
</div>

<!-- 댓글 작성 폼 -->
<form method="post" action="/comment/add">
    <input type="hidden" name="partyId" th:value="${party.id}" />
    <textarea name="content" placeholder="댓글을 입력하세요" required></textarea>
    <!-- ✅ CSRF 토큰 -->
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    <button type="submit">댓글 등록</button>
</form>

<!-- JS -->
<script>
    function deleteComment(commentId, partyId) {
        if (confirm("댓글을 삭제할까요?")) {
            const form = document.createElement("form");
            form.method = "post";
            form.action = "/comment/delete";

            const idInput = document.createElement("input");
            idInput.type = "hidden";
            idInput.name = "id";
            idInput.value = commentId;

            const partyIdInput = document.createElement("input");
            partyIdInput.type = "hidden";
            partyIdInput.name = "partyId";
            partyIdInput.value = partyId;

            // ✅ CSRF 토큰
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfParam = document.querySelector('meta[name="_csrf_parameter"]').getAttribute('content');
            const csrfInput = document.createElement("input");
            csrfInput.type = "hidden";
            csrfInput.name = csrfParam;
            csrfInput.value = csrfToken;

            form.appendChild(idInput);
            form.appendChild(partyIdInput);
            form.appendChild(csrfInput);

            document.body.appendChild(form);
            form.submit();
        }
    }

    function editComment(button) {
        const commentId = button.dataset.id;
        const partyId = button.dataset.partyid;
        const content = button.dataset.content;
        const gender = button.dataset.gender;
        const writerId = button.dataset.writerid;

        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfParam = document.querySelector('meta[name="_csrf_parameter"]').getAttribute('content');

        const commentDiv = document.getElementById("comment-" + commentId);
        const formHTML = `
            <form method="post" action="/comment/update">
                <input type="hidden" name="id" value="${commentId}" />
                <input type="hidden" name="partyId" value="${partyId}" />
                <input type="hidden" name="writerId" value="${writerId}" />
                <input type="hidden" name="gender" value="${gender}" />
                <input type="hidden" name="${csrfParam}" value="${csrfToken}" />
                <textarea name="content" required>${content}</textarea>
                <button type="submit">저장</button>
                <button type="button" onclick="cancelEdit()">취소</button>
            </form>
        `;
        commentDiv.innerHTML = formHTML;
    }

    function cancelEdit() {
        location.reload();
    }
</script>

</body>
</html>
